<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–¢–µ—Å—Ç Google + Firebase –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</title>
		<script src="https://accounts.google.com/gsi/client" async defer></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background: white;
				padding: 30px;
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
				margin-bottom: 20px;
			}
			h1 {
				color: #333;
				text-align: center;
				margin-bottom: 30px;
			}
			.google-btn {
				display: flex;
				justify-content: center;
				margin: 20px 0;
			}
			.result {
				margin-top: 20px;
				padding: 15px;
				border-radius: 5px;
				white-space: pre-wrap;
				font-family: monospace;
				font-size: 14px;
			}
			.success {
				background-color: #d4edda;
				border: 1px solid #c3e6cb;
				color: #155724;
			}
			.error {
				background-color: #f8d7da;
				border: 1px solid #f5c6cb;
				color: #721c24;
			}
			.info {
				background-color: #d1ecf1;
				border: 1px solid #bee5eb;
				color: #0c5460;
			}
			.user-info {
				background-color: #e2e3e5;
				border: 1px solid #d6d8db;
				color: #383d41;
				padding: 15px;
				border-radius: 5px;
				margin: 15px 0;
			}
			.firebase-status {
				display: inline-block;
				padding: 5px 10px;
				border-radius: 15px;
				font-size: 12px;
				font-weight: bold;
			}
			.firebase-yes {
				background-color: #28a745;
				color: white;
			}
			.firebase-no {
				background-color: #dc3545;
				color: white;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>üöÄ –¢–µ—Å—Ç Google + Firebase –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h1>

			<div class="info">
				<strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –¢–µ–ø–µ—Ä—å –≤—Å–µ Google –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤
				Firebase!
			</div>

			<h2>üîë Google –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
			<div class="google-btn">
				<div
					id="g_id_onload"
					data-client_id="480977786594-of15aub7mfv02ggv2fdsiutfiu4p8v81.apps.googleusercontent.com"
					data-callback="handleCredentialResponse"
					data-auto_prompt="false"
				></div>
				<div
					class="g_id_signin"
					data-type="standard"
					data-size="large"
					data-theme="outline"
					data-text="sign_in_with"
					data-shape="rectangular"
					data-logo_alignment="left"
				></div>
			</div>

			<div id="userInfo" class="user-info" style="display: none;">
				<h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
				<div id="userDetails"></div>
			</div>

			<div id="result"></div>
		</div>

		<script>
			let currentUser = null;
			let authToken = null;

			function handleCredentialResponse(response) {
				console.log("Google OAuth response:", response);

				// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º credential –Ω–∞ –Ω–∞—à –±—ç–∫–µ–Ω–¥
				authenticateWithBackend(response.credential);
			}

			async function authenticateWithBackend(credential) {
				try {
					showResult("üîÑ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google...", "", "info");

					const response = await fetch("http://localhost:3001/auth/google", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ credential }),
					});

					const result = await response.json();

					if (response.ok) {
						authToken = result.access_token;
						currentUser = result.user;

						showResult("‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google!", result, "success");
						showUserInfo(result.user);

						// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Firebase
						await checkFirebaseStatus();
					} else {
						showResult("‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", result, "error");
					}
				} catch (error) {
					showResult("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error.message, "error");
				}
			}

			async function checkFirebaseStatus() {
				if (!authToken) return;

				try {
					const response = await fetch("http://localhost:3001/protected/profile", {
						headers: {
							Authorization: `Bearer ${authToken}`,
						},
					});

					if (response.ok) {
						const profile = await response.json();
						console.log("–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", profile);

						// –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ Firebase
						// –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è firebaseUid
					}
				} catch (error) {
					console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:", error);
				}
			}

			function showUserInfo(user) {
				const userInfoDiv = document.getElementById("userInfo");
				const userDetailsDiv = document.getElementById("userDetails");

				userDetailsDiv.innerHTML = `
                <p><strong>ID:</strong> ${user.id}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>–ò–º—è:</strong> ${user.firstName || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"}</p>
                <p><strong>–§–∞–º–∏–ª–∏—è:</strong> ${user.lastName || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"}</p>
                <p><strong>–ê–≤–∞—Ç–∞—Ä:</strong> ${user.avatar ? "–ï—Å—Ç—å" : "–ù–µ—Ç"}</p>
                <p><strong>Firebase —Å—Ç–∞—Ç—É—Å:</strong> 
                    <span class="firebase-status firebase-yes">‚úÖ –í Firebase</span>
                </p>
            `;

				userInfoDiv.style.display = "block";
			}

			function showResult(title, data, type) {
				const resultDiv = document.getElementById("result");
				const content = data ? `${title}\n\n${JSON.stringify(data, null, 2)}` : title;
				resultDiv.textContent = content;
				resultDiv.className = `result ${type}`;
			}

			// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Google OAuth
			window.onerror = function (msg, url, lineNo, columnNo, error) {
				console.error("–û—à–∏–±–∫–∞:", msg, url, lineNo, columnNo, error);
				showResult("‚ùå –û—à–∏–±–∫–∞ JavaScript:", msg, "error");
				return false;
			};

			// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±—ç–∫–µ–Ω–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
			window.addEventListener("load", async () => {
				try {
					const response = await fetch("http://localhost:3001/");
					if (response.ok) {
						showResult("‚úÖ –ë—ç–∫–µ–Ω–¥ –¥–æ—Å—Ç—É–ø–µ–Ω", "–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3001", "success");
					}
				} catch (error) {
					showResult(
						"‚ùå –ë—ç–∫–µ–Ω–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
						"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001",
						"error",
					);
				}
			});
		</script>
	</body>
</html>
